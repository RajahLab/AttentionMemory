---
title: "LSA-behavioral-analyses.Rmd"
author: "Gabriela Vélez Largo"
last updated: "February 5, 2024"
output: html_document
editor_options: 
  chunk_output_type: inline
---

Description: This R script contains the code used to analyze behavioral data of the Lapses in Sustained Attention (LSA) study for Manuscript entitled "Post-stimulus Reaction Time at Encoding Predicts Subsequent Source Memory Performance and Modulates Underlying fMRI Activity in Healthy Young Adults" by Gabriela Vélez Largo, Abdelhalim Elshiekh, Sricharana Rajagopal, Stamatoula Pasvanis and M. Natasha Rajah.

Inputs: 

1. "LSA_RT_N38_PrePost.csv": dataset containing trial-by-trial reaction time and fMRI task accuracy observations of participants


Additional Information:
Run using R version 4.2.3 (2023-03-15) on DELL Latitude 5440 13th Gen Intel(R) Core(TM) i7-1355U.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# LIBRARIES

```{r Load libraries}
library(tidyverse) # version 2.0.0
library(languageR) # version 1.5.0
library(arm) # version 1.13.1
library(broom) # version 1.0.5
library(margins) #version 0.3.26
library(lme4) #version 1.1.34
library(MuMIn) #version 1.47.5

#Ensure the functions we use are not mixed with other functions from other packages.

rescale <- arm::rescale
select <- dplyr::select
```


# IMPORT AND ORGANIZE THE DATA
```{r Read RT and Scores datasets}

# Read the final data sets (i.e., after exclusions applied), Data with final sample size = 38 participants. 

#Read the Reaction time data set where each participant has ~ 192 observations (48 encoding events/Run x 4)

IDpostpreRT <- read.csv(file=  "LSA_RT_N38_PrePost.csv")

#Remove No responses in Post-stimulus and Pre-stimulus RT values (= 0 secs) and No responses at Retrieval Fate

IDpostpreRT <- filter(IDpostpreRT, PostRT > 0, PreRT > 0, Fate != "No response")

#Determine class of variables in all data sets. ID and Stimuli will be Grouping factors in the mixed-effects regression.

IDpostpreRT$ID <- as.factor(IDpostpreRT$ID)
IDpostpreRT$Stimuli <- as.factor(IDpostpreRT$Stimuli)


#Remove RT values under 107 msecs 

IDpostpreRT <-  filter(IDpostpreRT, PostRT > 107, PreRT > 107)


```



#STANDARDIZATION

```{r Standardization, include=FALSE}

#Standardize the predictors as follows: Continuous predictors are mean-centered and divided by 2 standard deviations.

rescale <- arm::rescale

IDpostpreRT <- mutate(IDpostpreRT, PostRTst = rescale(PostRT),PreRTst = rescale(PreRT))


```



#PRE/POST-STIMULUS RT MODEL
```{r Fit  model}

#Fit the mixed-effects logistic regression model for the main analysis. Dependent variable:'Source_Acc_coded' = source hit (1) or failure (0). Two predictors; pre- and post-stimulus RTs (PreRTst and PostRTst respectively). Suffix ‘st’ = predictor standardized. Two grouping factors; participants' ID and Stimuli. Optimizer; used to resolve convergence problems of the fitted model, a better optimizer for GLMMs.

glm_prepost1 <- glmer(Source_Acc_coded ~  PreRTst + PostRTst  + (1 + PostRTst |ID) + (1|Stimuli), data=IDpostpreRT, family='binomial', control = glmerControl(optimizer = "bobyqa"))

summary(glm_prepost1)

#Check significance of an effect by doing likelihood-ratio tests (F-test) between the full and reduced models :


#1. Verify if post-stimulus RT (PostRTst) effect is significant. 

#Fit model without PostRTst terms.

glma <- glmer(Source_Acc_coded ~  PreRTst  + (1  |ID) + (1|Stimuli), data=IDpostpreRT, family='binomial', control = glmerControl(optimizer = "bobyqa"))

#Perform F-test between full and reduced models.

anova(glm_prepost1, glma)

#2. Verify if post-stimulus RT random slope is significant. 

#Fit model without PostRTst random slope.

glmb <- glmer(Source_Acc_coded ~  PostRTst + PreRTst  + (1  |ID) + (1|Stimuli), data=IDpostpreRT, family='binomial', control = glmerControl(optimizer = "bobyqa"))

#Perform F-test between full and reduced models.

anova(glm_prepost1, glmb)

#3. Verify if PostRTst random slope correlation with Intercept is significant. 

#Fit the model without correlation term. 

glmc <- glmer(Source_Acc_coded ~  PostRTst + PreRTst  + (1 + PostRTst || ID) + (1|Stimuli), data=IDpostpreRT, family='binomial', control = glmerControl(optimizer = "bobyqa"))

#Perform F-test between full and reduced models.

anova(glm_prepost1, glmc) 



```


```{r Goodness of fit}

#Goodness of fit with R square measure

r.squaredGLMM(glm_prepost1)


```


#MARGINAL EFFECTS

```{r Average marginal effects}

#Fixed effects estimates for an average stimulus and participant in probability space.

marginal.effect <- margins(glm_prepost1) 
summary(marginal.effect)


```






